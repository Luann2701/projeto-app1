<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Painel do Dono</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="fundo-logo">

<div class="card grande">

    <h1>üëë Painel do Dono</h1>

    <!-- ===== BOT√ïES SUPERIORES ===== -->
    <div style="margin-bottom:20px; display:flex; gap:10px; justify-content:center;">
        <a href="/admin/eventos" class="btn">üì§ Gerenciar Eventos</a>
        <a href="/admin/horarios" class="btn">üïí Gerenciar Hor√°rios</a>
        <a href="/admin/relatorio_mensal" class="btn">üìä Relat√≥rio Mensal</a>
    </div>

    <!-- ===== FLASH MESSAGES ===== -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for categoria, mensagem in messages %}
                <div class="alert {{ categoria }}">{{ mensagem }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- ================= HOR√ÅRIOS FIXOS ================= -->
    <div class="barra-fixos" onclick="toggleFixos()">
        <span>‚è∞ Consultar Hor√°rios Fixos</span>
        <span id="icone-fixos">‚ñº</span>
    </div>

    <div class="box-fixos oculto" id="fixosBox">

        <!-- DATA PARA CANCELAR APENAS NO DIA -->
        <div style="margin-bottom:15px; text-align:center;">
            <label><strong>Data para cancelar apenas neste dia:</strong></label><br>
            <input type="date" id="data_cancelamento" style="padding:5px;">
        </div>

        {% if horarios_fixos %}
        <ul class="lista-fixos">

            {% for quadra, hora, nome, telefone in horarios_fixos %}
            <li style="display:flex; flex-direction:column; gap:10px; margin-bottom:15px;">

                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <strong>{{ quadra }}</strong> ‚Äî {{ hora }}<br>
                        <small>
                            üë§ {{ nome or 'N√£o informado' }}
                            {% if telefone and telefone != '‚Äî' %}
                                | üìû {{ telefone }}
                            {% endif %}
                        </small>
                    </div>

                    <!-- CANCELAR DEFINITIVO -->
                    <form method="POST"
                          action="/admin/cancelar_fixo_definitivo"
                          onsubmit="return confirm('Cancelar este hor√°rio FIXO definitivamente?');">

                        <input type="hidden" name="quadra" value="{{ quadra }}">
                        <input type="hidden" name="hora" value="{{ hora }}">

                        <button type="submit" class="btn pequeno secundario">
                            ‚ùå Cancelar definitivo
                        </button>
                    </form>
                </div>

                <!-- CANCELAR SOMENTE NO DIA -->
                <form method="POST"
                      action="/admin/cancelar_fixo_dia"
                      onsubmit="return confirmarCancelamentoDia(this);"
                      style="display:flex; gap:10px; align-items:center;">

                    <input type="hidden" name="quadra" value="{{ quadra }}">
                    <input type="hidden" name="hora" value="{{ hora }}">
                    <input type="hidden" name="data">

                    <button type="submit" class="btn pequeno">
                        ‚ùå Cancelar somente neste dia
                    </button>
                </form>

            </li>
            {% endfor %}
        </ul>
        {% else %}
            <p>Nenhum hor√°rio fixo cadastrado.</p>
        {% endif %}
    </div>

    <!-- ================= FILTROS ================= -->
    <form method="GET" class="filtros">
        <input type="date" name="data" value="{{ data_filtro or '' }}">

        <select name="quadra">
            <option value="">Todas as quadras</option>
            <option value="Quadra 1" {% if quadra_filtro == 'Quadra 1' %}selected{% endif %}>Quadra 1</option>
            <option value="Quadra 2" {% if quadra_filtro == 'Quadra 2' %}selected{% endif %}>Quadra 2</option>
            <option value="Quadra 3" {% if quadra_filtro == 'Quadra 3' %}selected{% endif %}>Quadra 3</option>
        </select>

        <button type="submit" class="btn pequeno">Filtrar</button>
        <a href="/painel_dono" class="btn secundario pequeno">Limpar</a>
    </form>

    <!-- ================= RESERVAS ================= -->
    <div class="tabela-box">
        <table>
            <thead>
                <tr>
                    <th>Cliente</th>
                    <th>Telefone</th>
                    <th>Esporte</th>
                    <th>Quadra</th>
                    <th>Data</th>
                    <th>Hor√°rio</th>
                    <th>Status</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>

            <tbody>
                {% for r in reservas %}
                <tr>
                    <td>{{ r[0] }}</td>
                    <td>{{ r[1] or '-' }}</td>
                    <td>{{ r[2] }}</td>
                    <td>{{ r[3] }}</td>
                    <td>{{ r[4] }}</td>
                    <td>{{ r[5] }}</td>

                    <td>
                        {% if r[6] %}
                            <span class="status pago">Pago</span>
                        {% else %}
                            <span class="status pendente">Pendente</span>
                        {% endif %}
                    </td>

                    <td>
                        <form method="POST"
                              action="/cancelar_reserva"
                              onsubmit="return confirm('Cancelar esta reserva?');">

                            <input type="hidden" name="usuario" value="{{ r[0] }}">
                            <input type="hidden" name="esporte" value="{{ r[2] }}">
                            <input type="hidden" name="quadra" value="{{ r[3] }}">
                            <input type="hidden" name="data" value="{{ r[4] }}">
                            <input type="hidden" name="horario" value="{{ r[5] }}">

                            <button type="submit" class="btn pequeno secundario">
                                ‚ùå Cancelar
                            </button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8">Nenhuma reserva encontrada</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <a href="/logout" class="btn secundario">Sair</a>

</div>

<!-- ================= SCRIPTS ================= -->
<script>
function toggleFixos() {
    const box = document.getElementById("fixosBox");
    const icone = document.getElementById("icone-fixos");

    box.classList.toggle("oculto");
    icone.textContent = box.classList.contains("oculto") ? "‚ñº" : "‚ñ≤";
}

function confirmarCancelamentoDia(form) {
    const data = document.getElementById("data_cancelamento").value;

    if (!data) {
        alert("Selecione uma data para cancelar apenas neste dia.");
        return false;
    }

    form.querySelector('input[name="data"]').value = data;
    return confirm("Cancelar este hor√°rio APENAS no dia " + data + "?");
}
</script>

</body>
</html>
