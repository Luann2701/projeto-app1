<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Painel do Dono</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <!-- ===== CSS DO MODAL (N√ÉO AFETA O RESTO) ===== -->
    <style>
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .modal-box {
            background: #fff;
            padding: 25px;
            border-radius: 14px;
            width: 90%;
            max-width: 420px;
            text-align: center;
            box-shadow: 0 0 25px rgba(0,0,0,0.35);
        }

        .modal-box h2 {
            margin-bottom: 10px;
        }

        .modal-botoes {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .btn-confirmar {
            flex: 1;
            background: #e53935;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
        }

        .btn-cancelar {
            flex: 1;
            background: #ddd;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
        }
    </style>
</head>

<body class="fundo-logo">

<div class="card grande">

    <h1>üëë Painel do Dono</h1>

    <!-- ================= BOT√ïES SUPERIORES ================= -->
    <div class="top-buttons">
        <a href="/admin/eventos" class="btn">üì§ Gerenciar Eventos</a>
        <a href="/admin/horarios" class="btn">üïí Gerenciar Hor√°rios</a>
        <a href="{{ url_for('relatorio_mensal') }}" class="btn">üìä Relat√≥rio Mensal</a>
    </div>

    <!-- ================= FLASH MESSAGES ================= -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for categoria, mensagem in messages %}
                <div class="alert {{ categoria }}">{{ mensagem }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- ================= HOR√ÅRIOS FIXOS ================= -->
    <form action="/admin/horarios-fixos" method="get">
        <button type="submit" class="barra-fixos" style="width:100%; cursor:pointer;">
            <span>‚è∞ Consultar Hor√°rios Fixos</span>
            <span id="icone-fixos">‚û°</span>
        </button>
    </form>

    <div class="box-fixos oculto" id="fixosBox">

        <div class="cancelamento-dia">
            <label><strong>Data para cancelar apenas neste dia:</strong></label><br>
            <input type="date" id="data_cancelamento">
        </div>

        {% if horarios_fixos %}
        <ul class="lista-fixos">
            {% for quadra, hora, nome, telefone in horarios_fixos %}
            <li class="item-fixo">
                <div class="info-fixo">
                    <strong>{{ quadra }}</strong> ‚Äî {{ hora }}<br>
                    <small>
                        üë§ {{ nome or 'N√£o informado' }}
                        {% if telefone and telefone != '‚Äî' %}
                            | üìû {{ telefone }}
                        {% endif %}
                    </small>
                </div>

                <div class="acoes-fixo">
                    <form method="POST"
                          action="/admin/cancelar_fixo_definitivo"
                          onsubmit="return confirm('Cancelar este hor√°rio FIXO definitivamente?');">
                        <input type="hidden" name="quadra" value="{{ quadra }}">
                        <input type="hidden" name="hora" value="{{ hora }}">
                        <button type="submit" class="btn pequeno secundario">
                            ‚ùå Cancelar definitivo
                        </button>
                    </form>

                    <form method="POST"
                          action="/admin/cancelar_fixo_dia"
                          onsubmit="return confirmarCancelamentoDia(this);">
                        <input type="hidden" name="quadra" value="{{ quadra }}">
                        <input type="hidden" name="hora" value="{{ hora }}">
                        <input type="hidden" name="data">
                        <button type="submit" class="btn pequeno">
                            ‚ùå Cancelar somente neste dia
                        </button>
                    </form>
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
            <p style="text-align:center;">Nenhum hor√°rio fixo cadastrado.</p>
        {% endif %}
    </div>

    <!-- ================= FILTROS ================= -->
    <form method="GET" class="filtros">
        <input type="date" name="data" value="{{ data_filtro or '' }}">

        <select name="quadra">
            <option value="">Todas as quadras</option>
            <option value="Quadra 1" {% if quadra_filtro == 'Quadra 1' %}selected{% endif %}>Quadra 1</option>
            <option value="Quadra 2" {% if quadra_filtro == 'Quadra 2' %}selected{% endif %}>Quadra 2</option>
            <option value="Quadra 3" {% if quadra_filtro == 'Quadra 3' %}selected{% endif %}>Quadra 3</option>
        </select>

        <button type="submit" class="btn pequeno">Filtrar</button>
        <a href="/painel_dono" class="btn pequeno secundario">Limpar</a>
    </form>

    <!-- ================= RESERVAS ================= -->
    <div class="tabela-box">
        <table>
            <thead>
                <tr>
                    <th>Cliente</th>
                    <th>Telefone</th>
                    <th>Esporte</th>
                    <th>Quadra</th>
                    <th>Data</th>
                    <th>Hor√°rio</th>
                    <th>Status</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>

            <tbody>
                {% for r in reservas %}
                <tr>
                    <td>{{ r[0] }}</td>
                    <td>{{ r[1] or '-' }}</td>
                    <td>{{ r[2] }}</td>
                    <td>{{ r[3] }}</td>
                    <td>{{ r[4] }}</td>
                    <td>{{ r[5] }}</td>
                    <td>
                        {% if r[6] %}
                            <span class="status pago">Pago</span>
                        {% else %}
                            <span class="status pendente">Pendente</span>
                        {% endif %}
                    </td>
                    <td>
                        <form method="POST"
                              action="/cancelar_reserva"
                              onsubmit="abrirModalReserva(this); return false;">
                            <input type="hidden" name="usuario" value="{{ r[0] }}">
                            <input type="hidden" name="esporte" value="{{ r[2] }}">
                            <input type="hidden" name="quadra" value="{{ r[3] }}">
                            <input type="hidden" name="data" value="{{ r[4] }}">
                            <input type="hidden" name="horario" value="{{ r[5] }}">
                            <button type="submit" class="btn pequeno secundario">
                                ‚ùå Cancelar
                            </button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8">Nenhuma reserva encontrada</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <a href="/logout" class="btn secundario">Sair</a>

</div>

<!-- ===== MODAL CANCELAR RESERVA ===== -->
<div id="modal-cancelar-reserva" class="modal-overlay">
    <div class="modal-box">
        <h2>Confirmar a√ß√£o</h2>
        <p>Cancelar esta <strong>reserva</strong>?</p>

        <div class="modal-botoes">
            <button id="btn-confirmar-reserva" class="btn-confirmar">
                Confirmar
            </button>
            <button class="btn-cancelar" onclick="fecharModalReserva()">
                Cancelar
            </button>
        </div>
    </div>
</div>

<!-- ================= SCRIPTS ================= -->
<script>
function confirmarCancelamentoDia(form) {
    const data = document.getElementById("data_cancelamento").value;
    if (!data) {
        alert("Selecione uma data para cancelar apenas neste dia.");
        return false;
    }
    form.querySelector('input[name="data"]').value = data;
    return confirm("Cancelar este hor√°rio APENAS no dia " + data + "?");
}

let formReserva = null;

function abrirModalReserva(form) {
    formReserva = form;
    document.getElementById("modal-cancelar-reserva").style.display = "flex";
}

function fecharModalReserva() {
    document.getElementById("modal-cancelar-reserva").style.display = "none";
    formReserva = null;
}

document.getElementById("btn-confirmar-reserva").onclick = function () {
    if (formReserva) {
        formReserva.submit();
    }
};
</script>

</body>
</html>
