<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Painel do Dono</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="fundo-logo">

<div class="card grande">

    <h1>üëë Painel do Dono</h1>

    <!-- ===== BOT√ïES SUPERIORES ===== -->
    <div style="margin-bottom:20px; display:flex; gap:10px; justify-content:center;">
        <a href="/admin/eventos" class="btn">üì§ Gerenciar Eventos</a>
        <a href="/admin/horarios" class="btn">üïí Gerenciar Hor√°rios</a>
        <a href="/admin/relatorio_mensal" class="btn">üìä Relat√≥rio Mensal</a>
    </div>

    <!-- ===== FLASH ===== -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for categoria, mensagem in messages %}
                <div class="alert {{ categoria }}">{{ mensagem }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- ================= HOR√ÅRIOS FIXOS ================= -->
    <div class="barra-fixos" onclick="toggleFixos()">
        <span>‚è∞ Consultar Hor√°rios Fixos</span>
        <span id="icone-fixos">‚ñº</span>
    </div>

    <div class="box-fixos oculto" id="fixosBox">

        {% if horarios_fixos %}
        <ul class="lista-fixos">

            {% for quadra, hora, nome, telefone, dia_semana in horarios_fixos %}
            <li class="fixo-item"
                data-dia="{{ dia_semana }}"
                data-quadra="{{ quadra }}"
                data-hora="{{ hora }}"
                style="display:flex; flex-direction:column; gap:10px; margin-bottom:20px;">

                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <strong>{{ quadra }}</strong> ‚Äî {{ hora }}<br>
                        <small>
                            üë§ {{ nome or 'N√£o informado' }}
                            {% if telefone %}
                                | üìû {{ telefone }}
                            {% endif %}
                        </small>
                    </div>

                    <!-- CANCELAR DEFINITIVO -->
                    <form method="POST"
                          action="/admin/cancelar_fixo_definitivo"
                          onsubmit="return confirm('Cancelar este hor√°rio FIXO definitivamente?');">
                        <input type="hidden" name="quadra" value="{{ quadra }}">
                        <input type="hidden" name="hora" value="{{ hora }}">
                        <button type="submit" class="btn pequeno secundario">
                            ‚ùå Cancelar definitivo
                        </button>
                    </form>
                </div>

                <!-- PR√ìXIMAS 4 DATAS -->
                <div class="datas-fixas" style="display:flex; gap:8px; flex-wrap:wrap;"></div>

            </li>
            {% endfor %}
        </ul>
        {% else %}
            <p>Nenhum hor√°rio fixo cadastrado.</p>
        {% endif %}
    </div>

    <a href="/logout" class="btn secundario">Sair</a>

</div>

<!-- ================= SCRIPTS ================= -->
<script>
function toggleFixos() {
    const box = document.getElementById("fixosBox");
    const icone = document.getElementById("icone-fixos");
    box.classList.toggle("oculto");
    icone.textContent = box.classList.contains("oculto") ? "‚ñº" : "‚ñ≤";
}

function proximasDatas(diaSemana, total = 4) {
    const hoje = new Date();
    hoje.setHours(0,0,0,0);
    const datas = [];
    let d = new Date(hoje);

    while (datas.length < total) {
        if (d.getDay() === diaSemana && d >= hoje) {
            datas.push(new Date(d));
        }
        d.setDate(d.getDate() + 1);
    }
    return datas;
}

document.querySelectorAll(".fixo-item").forEach(item => {
    const diaSemana = parseInt(item.dataset.dia);
    const quadra = item.dataset.quadra;
    const hora = item.dataset.hora;
    const container = item.querySelector(".datas-fixas");

    proximasDatas(diaSemana).forEach(d => {
        const iso = d.toISOString().split("T")[0];
        const label = d.toLocaleDateString("pt-BR", {
            day: "2-digit",
            month: "2-digit"
        });

        container.innerHTML += `
            <form method="POST" action="/admin/cancelar_fixo_dia"
                  onsubmit="return confirm('Cancelar apenas o dia ${label}?');">
                <input type="hidden" name="quadra" value="${quadra}">
                <input type="hidden" name="hora" value="${hora}">
                <input type="hidden" name="data" value="${iso}">
                <button type="submit" class="btn pequeno">${label}</button>
            </form>
        `;
    });
});
</script>

</body>
</html>
